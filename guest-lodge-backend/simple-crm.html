<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketel Â· Front Desk</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#EEF2EF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #2E7D5B; --green-light: #4CAF7D; --green-pale: #E8F5EE;
      --green-mint: #C8EDD9; --bg: #EEF2EF; --white: #FFFFFF;
      --text: #1A2B22; --text-muted: #6B7D72; --border: #D8E4DC;
      --red: #E05252; --amber: #F59E0B;
      --shadow: 0 2px 12px rgba(46,125,91,0.10);
      --shadow-lg: 0 8px 32px rgba(46,125,91,0.14);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    /* â”€â”€ LOGIN â”€â”€ */
    .login-screen {
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #1a2b22 0%, #2E7D5B 100%);
    }
    .login-card {
      background: white; border-radius: 20px; padding: 40px 36px; width: 340px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;
    }
    .login-logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px; }
    .login-logo-icon { height: 48px; width: auto; }
    .login-logo-text { height: 28px; width: auto; }
    .login-card p { font-size: 13px; color: var(--text-muted); margin-bottom: 24px; }
    .login-input {
      width: 100%; padding: 12px 16px; border: 1.5px solid var(--border);
      border-radius: 12px; font-family: inherit; font-size: 18px; text-align: center;
      letter-spacing: 4px; outline: none; margin-bottom: 12px; color: var(--text);
      transition: border-color 0.2s;
    }
    .login-input:focus { border-color: var(--green); }
    .login-btn {
      width: 100%; padding: 13px; background: var(--green); color: white;
      border: none; border-radius: 12px; font-family: inherit; font-size: 15px;
      font-weight: 600; cursor: pointer; transition: background 0.15s;
    }
    .login-btn:hover { background: #245f46; }
    .login-error { color: var(--red); font-size: 13px; margin-top: 8px; min-height: 20px; }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      background: var(--white); border-bottom: 1.5px solid var(--border);
      padding: 0 24px; height: 58px; display: flex; align-items: center;
      justify-content: space-between; position: sticky; top: 0; z-index: 100;
      box-shadow: 0 1px 8px rgba(46,125,91,0.07);
    }
    .header-logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 15px; color: var(--text); }
    .header-logo-icon { height: 32px; width: auto; }
    .header-logo-text { height: 20px; width: auto; }
    .header-logo-suffix { margin-left: 2px; color: var(--text-muted); font-weight: 600; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .stat-pill {
      background: var(--green-pale); border-radius: 20px; padding: 4px 12px;
      font-size: 12px; font-weight: 600; color: var(--green); display: flex; align-items: center; gap: 4px;
    }
    .refresh-btn {
      background: var(--green-pale); border: 1.5px solid var(--border); border-radius: 8px;
      padding: 5px 12px; font-family: inherit; font-size: 12px; font-weight: 600;
      color: var(--green); cursor: pointer; transition: all 0.15s;
    }
    .refresh-btn:hover { background: var(--green); color: white; border-color: var(--green); }

    /* â”€â”€ LAYOUT â”€â”€ */
    .container { max-width: 860px; margin: 0 auto; padding: 24px 20px; }

    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 16px; font-weight: 700; color: var(--text);
      display: flex; align-items: center; gap: 8px;
    }
    .count-badge {
      background: var(--green); color: white;
      padding: 2px 9px; border-radius: 20px; font-size: 11px; font-weight: 700;
    }

    /* â”€â”€ BOOKING CARD â”€â”€ */
    .booking-card {
      background: var(--white); border: 1.5px solid var(--border);
      border-radius: 14px; overflow: hidden;
      box-shadow: var(--shadow); margin-bottom: 10px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .booking-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

    .card-accent { height: 3px; background: var(--green); }
    .card-accent.declined { background: var(--amber); }

    .card-inner { padding: 14px 16px; }

    /* TOP ROW */
    .card-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
    .guest-info { display: flex; flex-direction: column; gap: 3px; }
    .guest-name { font-size: 17px; font-weight: 700; color: var(--text); line-height: 1.2; }
    .guest-time { font-size: 11px; color: var(--text-muted); font-weight: 500; }

    .card-amount { 
      font-family: 'DM Mono', monospace; font-size: 17px; font-weight: 700;
      color: var(--green); text-align: right; flex-shrink: 0; margin-left: 12px;
    }

    /* META ROW */
    .card-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    .meta-chip {
      display: flex; align-items: center; gap: 3px; background: var(--bg);
      border-radius: 7px; padding: 3px 8px; font-size: 11px; color: var(--text-muted); font-weight: 500;
    }
    .declined-chip {
      background: #FEF3C7; color: #92400E; border-radius: 7px;
      padding: 3px 8px; font-size: 11px; font-weight: 600;
      display: flex; align-items: center; gap: 3px;
    }

    /* DATES */
    .card-dates {
      display: flex; gap: 0; margin-bottom: 12px;
      background: var(--bg); border-radius: 10px; overflow: hidden;
      border: 1.5px solid var(--border);
    }
    .date-block {
      flex: 1; padding: 8px 12px; display: flex; flex-direction: column; gap: 2px;
    }
    .date-block + .date-block { border-left: 1.5px solid var(--border); }
    .date-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
    .date-value { font-size: 13px; font-weight: 600; color: var(--text); }

    /* CONTACT ROW */
    .card-contact { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 10px; }
    .contact-details { display: flex; flex-direction: column; gap: 2px; }
    .contact-phone { font-size: 18px; font-weight: 700; color: var(--green); font-family: 'DM Mono', monospace; }
    .contact-email { font-size: 11px; color: var(--text-muted); }

    .phone-call-btn {
      display: flex; align-items: center; gap: 6px;
      background: var(--green); color: white;
      border: none; border-radius: 10px; padding: 9px 16px;
      font-family: inherit; font-size: 13px; font-weight: 700;
      cursor: pointer; text-decoration: none; transition: all 0.15s;
      flex-shrink: 0;
    }
    .phone-call-btn:hover { background: #245f46; transform: scale(1.03); }

    /* FOOTER */
    .card-footer { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }
    .btn {
      flex: 1; padding: 9px 12px; border-radius: 10px; font-family: inherit;
      font-size: 12px; font-weight: 600; cursor: pointer; border: 1.5px solid transparent;
      transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .btn-confirm { background: var(--green); color: white; }
    .btn-confirm:hover { background: #245f46; }
    .btn-note { background: var(--white); color: var(--text); border-color: var(--border); }
    .btn-note:hover { border-color: var(--green); color: var(--green); background: var(--green-pale); }

    /* â”€â”€ STATES â”€â”€ */
    .empty-state {
      text-align: center; padding: 64px 20px;
      background: var(--white); border: 1.5px solid var(--border);
      border-radius: 14px; box-shadow: var(--shadow);
    }
    .empty-icon { font-size: 40px; margin-bottom: 12px; }
    .empty-text { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .empty-sub { font-size: 13px; color: var(--text-muted); }

    .loading {
      display: flex; align-items: center; justify-content: center;
      height: 200px; font-size: 14px; color: var(--text-muted); gap: 10px;
    }
    .spinner {
      width: 18px; height: 18px; border: 2px solid var(--border);
      border-top-color: var(--green); border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ TOAST â”€â”€ */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 7px; }
    .toast {
      background: var(--text); color: white; border-radius: 11px; padding: 11px 16px;
      font-size: 12px; font-weight: 600; box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 7px;
      animation: slideInR 0.2s ease, fadeOut 0.3s ease 2.7s forwards;
    }
    @keyframes slideInR { from{transform:translateX(40px);opacity:0} to{transform:translateX(0);opacity:1} }
    @keyframes fadeOut { to{opacity:0;transform:translateX(20px)} }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--red); }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 600px) {
      .header { padding: 0 14px; }
      .header-right .stat-pill { display: none; }
      .container { padding: 16px 12px; }
      .card-inner { padding: 12px 14px; }
      .contact-phone { font-size: 15px; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <img src="/marketellogo.svg" alt="" class="login-logo-icon">
      <img src="/marketel.svg" alt="Marketel" class="login-logo-text">
    </div>
    <p>Front Desk â€” Enter your PIN to continue</p>
    <input class="login-input" type="password" id="pinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20"
      onkeydown="if(event.key==='Enter') doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <header class="header">
    <div class="header-logo">
      <img src="/marketellogo.svg" alt="" class="header-logo-icon">
      <img src="/marketel.svg" alt="Marketel" class="header-logo-text">
      <span class="header-logo-suffix">Front Desk</span>
    </div>
    <div class="header-right">
      <div id="statNew" class="stat-pill">ğŸ“¥ <strong id="statCount">0</strong> Needs Call</div>
      <button class="refresh-btn" onclick="addDummyBookings()">â• Test Bookings</button>
      <button class="refresh-btn" id="btnNotify" onclick="enableNotifications()">ğŸ”” Notifications</button>
      <button class="refresh-btn" onclick="loadBookings()">â†» Refresh</button>
    </div>
  </header>

  <div class="container">
    <div class="page-header">
      <div class="page-title">
        ğŸ“ Needs a Call
        <span class="count-badge" id="bookingCount">0</span>
      </div>
    </div>
    <div id="bookingsList">
      <div class="loading"><div class="spinner"></div> Loading bookingsâ€¦</div>
    </div>
  </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
let token = '';
let bookings = [];

try { token = localStorage.getItem('crmToken') || ''; } catch(e) {}

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  const pin = document.getElementById('pinInput').value.trim();
  const err = document.getElementById('loginError');
  if (!pin) { err.textContent = 'Please enter PIN'; return; }
  token = pin;
  try { localStorage.setItem('crmToken', token); } catch(e) {}
  err.textContent = '';
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadBookings();
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json', 'x-crm-token': token } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (res.status === 401) { showLogin(); throw new Error('Unauthorized'); }
  return res.json();
}

function showLogin() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  token = '';
  try { localStorage.removeItem('crmToken'); } catch(e) {}
}

// â”€â”€ LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBookings() {
  try {
    const data = await api('GET', '/api/crm/bookings');
    if (!data.success) throw new Error(data.message);
    bookings = data.data || [];
    const needsCalls = bookings.filter(b => b.callStatus === 'not-called');
    renderBookings(needsCalls);
  } catch(e) {
    if (e.message === 'Unauthorized') return;
    document.getElementById('bookingsList').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">âš ï¸</div>
        <div class="empty-text">Could not load bookings</div>
        <div class="empty-sub">${esc(e.message)}</div>
      </div>`;
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBookings(list) {
  document.getElementById('bookingCount').textContent = list.length;
  document.getElementById('statCount').textContent = list.length;

  const el = document.getElementById('bookingsList');

  if (list.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">âœ…</div>
        <div class="empty-text">All caught up!</div>
        <div class="empty-sub">No bookings need a call right now.</div>
      </div>`;
    return;
  }

  el.innerHTML = list.map(b => {
    const isDeclined = b.notes && b.notes.includes('PAYMENT DECLINED');
    const ci = b.checkinDate ? new Date(b.checkinDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'â€”';
    const co = b.checkoutDate ? new Date(b.checkoutDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'â€”';
    const ago = timeAgo(b.createdAt);

    return `
    <div class="booking-card">
      <div class="card-accent ${isDeclined ? 'declined' : ''}"></div>
      <div class="card-inner">

        <div class="card-top">
          <div class="guest-info">
            <div class="guest-name">${esc(b.guestFirstName)} ${esc(b.guestLastName)}</div>
            <div class="guest-time">${ago}</div>
          </div>
          <div class="card-amount">$${Number(b.grandTotal).toFixed(2)}</div>
        </div>

        <div class="card-meta">
          <div class="meta-chip">ğŸ› ${esc(b.roomName || 'Room')}</div>
          <div class="meta-chip">ğŸŒ™ ${b.nights} night${b.nights !== 1 ? 's' : ''}</div>
          ${b.bookingType === 'payLater' ? '<div class="meta-chip">ğŸ’³ Pay at hotel</div>' : ''}
          ${isDeclined ? '<div class="declined-chip">âš ï¸ Card declined</div>' : ''}
        </div>

        <div class="card-dates">
          <div class="date-block">
            <div class="date-label">Check-in</div>
            <div class="date-value">${ci}</div>
          </div>
          <div class="date-block">
            <div class="date-label">Check-out</div>
            <div class="date-value">${co}</div>
          </div>
          <div class="date-block">
            <div class="date-label">Guests</div>
            <div class="date-value">${b.guests || 1} guest${(b.guests || 1) !== 1 ? 's' : ''}</div>
          </div>
        </div>

        <div class="card-contact">
          <div class="contact-details">
            <div class="contact-phone">${esc(b.guestPhone)}</div>
            <div class="contact-email">${esc(b.guestEmail)}</div>
          </div>
          <a href="tel:${esc(b.guestPhone)}" class="phone-call-btn">ğŸ“ Call</a>
        </div>

        <div class="card-footer">
          <button class="btn btn-confirm" onclick="markConfirmed('${b.id}')">âœ“ Mark Called</button>
          <button class="btn btn-note" onclick="addNote('${b.id}')">ğŸ“ Add Note</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function markConfirmed(id) {
  try {
    await api('POST', `/api/crm/bookings/${id}/confirm`);
    bookings = bookings.map(b => b.id === id ? { ...b, callStatus: 'called' } : b);
    renderBookings(bookings.filter(b => b.callStatus === 'not-called'));
    toast('Marked as called', 'success');
  } catch(e) { toast('Failed to update', 'error'); }
}

async function addNote(id) {
  const note = prompt('Add a note for this booking:');
  if (!note) return;
  try {
    await api('POST', `/api/crm/bookings/${id}/note`, { note });
    toast('Note saved', 'success');
  } catch(e) { toast('Failed to save note', 'error'); }
}

// â”€â”€ ADD DUMMY BOOKINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addDummyBookings() {
  if (!confirm('Add 4 test bookings (1 with payment declined)?')) return;
  try {
    const data = await api('POST', '/api/crm/add-dummy-bookings');
    if (data.success) {
      toast(`Added ${data.count} test bookings`, 'success');
      loadBookings();
    } else {
      toast('Failed to add test bookings', 'error');
    }
  } catch(e) {
    toast('Error adding test bookings', 'error');
  }
}

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const output = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) output[i] = rawData.charCodeAt(i);
  return output;
}

async function enableNotifications() {
  if (!token) { toast('Sign in first', 'error'); return; }
  try {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') { toast('Notifications blocked', 'error'); return; }
    const keyRes = await fetch('/api/push/vapid-public');
    const keyData = await keyRes.json().catch(() => ({}));
    if (!keyData.publicKey) { toast('Push not configured', 'error'); return; }
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(keyData.publicKey)
    });
    const bufToB64 = buf => btoa(String.fromCharCode.apply(null, new Uint8Array(buf)));
    await api('POST', '/api/push/subscribe', {
      endpoint: sub.endpoint,
      p256dh: sub.getKey('p256dh') ? bufToB64(sub.getKey('p256dh')) : '',
      auth: sub.getKey('auth') ? bufToB64(sub.getKey('auth')) : ''
    });
    toast('Notifications enabled', 'success');
    document.getElementById('btnNotify').textContent = 'ğŸ”” On';
  } catch(e) { toast('Failed: ' + (e.message || e), 'error'); }
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

function toast(msg, type = '') {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = `${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹'} ${msg}`;
  c.appendChild(el);
  setTimeout(() => el.remove(), 3100);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(() => {});
document.getElementById('pinInput').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

if (token) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadBookings();
}

setInterval(loadBookings, 30000);
</script>
</body>
</html>
