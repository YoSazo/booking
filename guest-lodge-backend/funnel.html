<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Marketel Funnel</title>
<link rel="manifest" href="/manifest-funnel.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/marketellogo.svg">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --white: #ffffff;
    --bg: #f5f4f1;
    --bg2: #eeecea;
    --card: #ffffff;
    --border: #e8e5e0;
    --border2: #d8d4ce;
    --ink: #1a1714;
    --ink2: #3d3a36;
    --muted: #8a8580;
    --muted2: #b0aca6;
    --green: #1a9e5c;
    --green-lt: #e8f7ef;
    --green-mid: #d0f0e0;
    --green-bright: #22c76e;
    --amber: #d97706;
    --amber-lt: #fef3c7;
    --red: #dc2626;
    --red-lt: #fee2e2;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --pink: #ec4899;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 16px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
    --shadow-lg: 0 12px 40px rgba(0,0,0,0.10), 0 4px 12px rgba(0,0,0,0.06);
    --r: 18px;
    --r-sm: 12px;
    --r-xs: 8px;
  }

  body {
    font-family: 'Geist', sans-serif;
    background: #dbd8d3;
    min-height: 100vh;
    color: var(--ink);
  }

  /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
  .login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--ink) 0%, var(--green) 100%);
  }
  .login-card {
    background: white;
    border-radius: 24px;
    padding: 48px 40px;
    width: 380px;
    max-width: calc(100% - 32px);
    box-shadow: var(--shadow-lg);
    text-align: center;
  }
  .login-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
  }
  .login-logo-icon { height: 56px; width: auto; }
  .login-logo-text { height: 32px; width: auto; }
  .login-card p {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 28px;
  }
  .login-input {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid var(--border);
    border-radius: var(--r-sm);
    font-family: inherit;
    font-size: 18px;
    text-align: center;
    letter-spacing: 4px;
    outline: none;
    margin-bottom: 16px;
    color: var(--ink);
    transition: border-color 0.2s, box-shadow 0.2s;
    background: var(--bg);
  }
  .login-input:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 3px var(--green-lt);
  }
  .login-btn {
    width: 100%;
    padding: 14px;
    background: var(--green);
    color: white;
    border: none;
    border-radius: var(--r-sm);
    font-family: inherit;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }
  .login-btn:hover {
    background: #16844d;
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  .login-btn:active {
    transform: translateY(0);
  }
  .login-error {
    color: var(--red);
    font-size: 13px;
    margin-top: 12px;
  }

  /* ‚îÄ‚îÄ MAIN CONTAINER ‚îÄ‚îÄ */
  .container {
    max-width: 100%;
    margin: 0 auto;
    padding: 24px 16px 80px;
  }

  @media (min-width: 768px) {
    .container {
      max-width: 480px;
      padding: 32px 24px 80px;
    }
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .header-brand {
    font-family: 'Instrument Serif', serif;
    font-size: 24px;
    color: var(--ink);
    letter-spacing: -0.3px;
  }
  .header-brand em {
    color: var(--green);
    font-style: italic;
  }
  .header-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .icon-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    transition: all 0.2s;
  }
  .icon-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  .icon-btn.active {
    background: var(--green);
    border-color: var(--green);
    color: white;
  }

  /* ‚îÄ‚îÄ GREETING ‚îÄ‚îÄ */
  .greeting {
    margin-bottom: 8px;
  }
  .greeting-sub {
    font-size: 13px;
    color: var(--muted);
    font-weight: 400;
    margin-bottom: 4px;
  }
  .greeting-title {
    font-family: 'Instrument Serif', serif;
    font-size: 32px;
    color: var(--ink);
    line-height: 1.1;
    letter-spacing: -0.5px;
  }

  /* ‚îÄ‚îÄ LIVE TAG ‚îÄ‚îÄ */
  .live-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--green-lt);
    border: 1px solid var(--green-mid);
    border-radius: 20px;
    padding: 6px 14px 6px 10px;
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
    margin: 12px 0 16px;
  }
  .live-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--green-bright);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34, 199, 110, 0.4); }
    50% { box-shadow: 0 0 0 5px rgba(34, 199, 110, 0); }
  }

  /* ‚îÄ‚îÄ HERO CARD ‚îÄ‚îÄ */
  .hero-card {
    background: var(--ink);
    border-radius: var(--r);
    padding: 24px;
    color: #fff;
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: var(--shadow-lg);
  }
  .hero-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 90% -20%, rgba(34, 199, 110, 0.3) 0%, transparent 55%),
      radial-gradient(ellipse at -10% 110%, rgba(34, 199, 110, 0.12) 0%, transparent 50%);
    pointer-events: none;
  }
  .hero-label {
    font-size: 11px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.45);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 10px;
    position: relative;
  }
  .hero-amount {
    font-family: 'Instrument Serif', serif;
    font-size: 52px;
    letter-spacing: -2px;
    line-height: 1;
    margin-bottom: 8px;
    position: relative;
  }
  .hero-amount-sm {
    font-size: 28px;
    color: rgba(255, 255, 255, 0.65);
  }
  .hero-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.5);
    position: relative;
  }
  .hero-badge {
    background: rgba(34, 199, 110, 0.2);
    color: #5de89a;
    border-radius: 6px;
    padding: 2px 8px;
    font-size: 11.5px;
    font-weight: 700;
  }
  .hero-badge.red {
    background: rgba(220, 38, 38, 0.2);
    color: #fca5a5;
  }
  .hero-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.08);
    margin: 18px 0;
    position: relative;
  }
  .hero-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    position: relative;
  }
  .hstat {
    padding: 0 12px;
    border-right: 1px solid rgba(255, 255, 255, 0.08);
    text-align: center;
  }
  .hstat:first-child {
    padding-left: 0;
    text-align: left;
  }
  .hstat:last-child {
    border-right: none;
    text-align: right;
  }
  .hstat-val {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    letter-spacing: -0.5px;
    color: #fff;
    margin-bottom: 2px;
  }
  .hstat-val.green {
    color: #5de89a;
  }
  .hstat-val.amber {
    color: #fbbf24;
  }
  .hstat-lbl {
    font-size: 10px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.35);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
  .sec-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 24px 0 12px;
  }
  .sec-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: -0.2px;
  }
  .sec-action {
    font-size: 12.5px;
    font-weight: 500;
    color: var(--green);
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .sec-action:hover {
    opacity: 0.7;
  }

  /* ‚îÄ‚îÄ META TOOLBAR ‚îÄ‚îÄ */
  .meta-toolbar {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
  }
  .meta-btn {
    padding: 7px 14px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--ink);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }
  .meta-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  .meta-btn:active {
    transform: translateY(0);
  }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 16px;
  }

  /* ‚îÄ‚îÄ FUNNEL STEPS ‚îÄ‚îÄ */
  .funnel-steps {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .funnel-step {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--bg);
    border-radius: var(--r-sm);
    border-left: 4px solid;
    transition: all 0.2s;
    cursor: pointer;
  }
  .funnel-step:hover {
    background: var(--bg2);
    transform: translateX(4px);
  }
  .funnel-step:nth-child(1) { border-left-color: var(--blue); }
  .funnel-step:nth-child(2) { border-left-color: var(--purple); }
  .funnel-step:nth-child(3) { border-left-color: var(--pink); }
  .funnel-step:nth-child(4) { border-left-color: var(--amber); }
  .funnel-step:nth-child(5) { border-left-color: var(--green); }
  
  .funnel-step-emoji {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }
  .funnel-step-label {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
  }
  .funnel-step-count {
    background: var(--white);
    color: var(--ink);
    border-radius: 10px;
    padding: 5px 12px;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Geist', monospace;
    box-shadow: var(--shadow-sm);
  }
  .funnel-step-pct {
    font-size: 11px;
    color: var(--muted);
    font-weight: 600;
    min-width: 48px;
    text-align: right;
  }

  /* ‚îÄ‚îÄ CHART CARD ‚îÄ‚îÄ */
  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 16px;
  }
  .chart-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .chart-kpi {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    letter-spacing: -1px;
    color: var(--ink);
  }
  .chart-kpi-lbl {
    font-size: 11px;
    color: var(--muted);
    font-weight: 500;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }
  .chart-kpi-change {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    font-weight: 600;
    color: var(--green);
    background: var(--green-lt);
    border-radius: 6px;
    padding: 3px 8px;
    margin-top: 6px;
  }
  .chart-tabs {
    display: flex;
    gap: 2px;
    background: var(--bg2);
    border-radius: 10px;
    padding: 3px;
  }
  .ctab {
    padding: 5px 11px;
    border-radius: 8px;
    font-size: 11.5px;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }
  .ctab.on {
    background: var(--white);
    color: var(--ink);
    box-shadow: var(--shadow-sm);
  }

  /* ‚îÄ‚îÄ META METRICS GRID ‚îÄ‚îÄ */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .metric-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r-sm);
    padding: 14px;
    box-shadow: var(--shadow-sm);
  }
  .metric-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 600;
  }
  .metric-value {
    font-family: 'Instrument Serif', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--ink);
    letter-spacing: -0.5px;
  }

  /* ‚îÄ‚îÄ RECENT ACTIVITY ‚îÄ‚îÄ */
  .recent-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .recent-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--r-sm);
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
  }
  .recent-item:hover {
    transform: translateX(4px);
  }
  .recent-stripe {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--green-bright);
    border-radius: 0 2px 2px 0;
  }
  .recent-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .recent-info {
    flex: 1;
    min-width: 0;
  }
  .recent-event {
    font-size: 13px;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 2px;
  }
  .recent-meta {
    font-size: 11px;
    color: var(--muted);
  }
  .recent-time {
    font-size: 10px;
    color: var(--muted2);
    font-weight: 500;
    font-family: 'Geist', monospace;
    flex-shrink: 0;
  }
  .recent-empty {
    color: var(--muted);
    font-size: 13px;
    padding: 32px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ META MODAL ‚îÄ‚îÄ */
  .meta-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
    padding: 16px;
  }
  .meta-modal {
    background: var(--white);
    border-radius: var(--r);
    padding: 20px;
    box-shadow: var(--shadow-lg);
    max-width: 420px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .meta-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
    flex-wrap: wrap;
  }
  .meta-modal-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
  }
  .meta-modal-body {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .meta-date-btn {
    padding: 10px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--r-sm);
    font-size: 12px;
    font-weight: 600;
    color: var(--ink);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .meta-date-btn:hover {
    background: var(--bg2);
  }
  .meta-date-btn.selected {
    background: var(--green);
    color: #fff;
    border-color: var(--green);
  }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .anim {
    animation: fadeUp 0.5s ease both;
  }
  .a1 { animation-delay: 0.05s; }
  .a2 { animation-delay: 0.12s; }
  .a3 { animation-delay: 0.20s; }
  .a4 { animation-delay: 0.28s; }
  .a5 { animation-delay: 0.36s; }
  .a6 { animation-delay: 0.44s; }
  .a7 { animation-delay: 0.52s; }
  
  /* Responsive adjustments */
  @media (max-width: 640px) {
    .hero-amount { font-size: 42px; }
    .hero-stats { grid-template-columns: 1fr; gap: 12px; }
    .hstat { border-right: none; border-bottom: 1px solid rgba(255, 255, 255, 0.08); padding: 8px 0; text-align: left !important; }
    .hstat:last-child { border-bottom: none; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <img src="/marketellogo.svg" alt="" class="login-logo-icon">
      <img src="/marketel.svg" alt="Marketel" class="login-logo-text">
    </div>
    <p>Enter your PIN to continue</p>
    <input class="login-input" type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20"
      onkeydown="if(event.key==='Enter') doLogin()">
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<div class="container">
  <!-- HEADER -->
  <div class="header anim a1">
    <div class="header-brand">Marketel <em>Funnel</em></div>
    <div class="header-right">
      <button class="icon-btn" id="btnNotify" onclick="enableFunnelNotifications()" title="Get notified for new bookings">üîî</button>
      <button class="icon-btn" onclick="handleRefresh()" title="Refresh data">‚Üª</button>
    </div>
  </div>

  <!-- GREETING -->
  <div class="greeting anim a2">
    <div class="greeting-sub" id="headerDate"></div>
    <div class="greeting-title">Conversion<br>Analytics</div>
  </div>

  <!-- LIVE TAG -->
  <div class="live-tag anim a2">
    <div class="live-dot"></div>
    <span id="liveStatus">Live tracking ¬∑ Updates every 3s</span>
  </div>

  <!-- HERO CARD: Conversion Rate -->
  <div class="hero-card anim a3">
    <div class="hero-label">Overall Conversion Rate</div>
    <div class="hero-amount"><span class="hero-amount-sm" id="heroConversionRate">0%</span></div>
    <div class="hero-meta">
      <span class="hero-badge" id="heroConversionBadge">‚Äî</span>
      <span id="heroConversionMeta">Search to Purchase</span>
    </div>
    <div class="hero-divider"></div>
    <div class="hero-stats">
      <div class="hstat">
        <div class="hstat-val green" id="heroSearches">0</div>
        <div class="hstat-lbl">Searches</div>
      </div>
      <div class="hstat">
        <div class="hstat-val" id="heroCarts">0</div>
        <div class="hstat-lbl">Add to Cart</div>
      </div>
      <div class="hstat">
        <div class="hstat-val amber" id="heroPurchases">0</div>
        <div class="hstat-lbl">Purchases</div>
      </div>
    </div>
  </div>

  <!-- META ADS SECTION -->
  <div class="sec-header anim a4">
    <span class="sec-title">Meta Ads Performance</span>
  </div>

  <div class="meta-toolbar anim a4">
    <button class="meta-btn" onclick="setMetaRange('today')">Today</button>
    <button class="meta-btn" onclick="setMetaRange('yesterday')">Yesterday</button>
    <button class="meta-btn" onclick="setMetaRange('last7')">Last 7 days</button>
    <button class="meta-btn" onclick="openMetaModal()">Choose dates</button>
    <button class="meta-btn" onclick="copyMetaSummary()">üìã Copy</button>
  </div>

    <div class="metric-card">
      <div class="metric-label">Ad Spend</div>
      <div class="metric-value" id="meta-spend">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">CPM</div>
      <div class="metric-value" id="meta-cpm">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">CTR</div>
      <div class="metric-value" id="meta-ctr">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">ROAS</div>
      <div class="metric-value" id="meta-roas">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">LP Views</div>
      <div class="metric-value" id="meta-lpv">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Searches</div>
      <div class="metric-value" id="meta-search">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Add to Cart</div>
      <div class="metric-value" id="meta-atc">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Checkouts</div>
      <div class="metric-value" id="meta-ic">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Payment Info</div>
      <div class="metric-value" id="meta-api">‚Äì</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Purchases</div>
      <div class="metric-value" id="meta-purchase">‚Äì</div>
    </div>
  </div>

  <!-- FUNNEL STEPS -->
  <div class="sec-header anim a5">
    <span class="sec-title">Funnel Steps</span>
  </div>

  <div class="card anim a5">
    <div class="funnel-steps" id="funnelSteps">
      <div class="funnel-step">
        <span class="funnel-step-emoji">üîç</span>
        <span class="funnel-step-label">Search</span>
        <span class="funnel-step-count" id="count-Search">0</span>
        <span class="funnel-step-pct" id="pct-Search"></span>
      </div>
      <div class="funnel-step">
        <span class="funnel-step-emoji">üõí</span>
        <span class="funnel-step-label">Add to Cart</span>
        <span class="funnel-step-count" id="count-AddToCart">0</span>
        <span class="funnel-step-pct" id="pct-AddToCart"></span>
      </div>
      <div class="funnel-step">
        <span class="funnel-step-emoji">üìã</span>
        <span class="funnel-step-label">Initiate Checkout</span>
        <span class="funnel-step-count" id="count-InitiateCheckout">0</span>
        <span class="funnel-step-pct" id="pct-InitiateCheckout"></span>
      </div>
      <div class="funnel-step">
        <span class="funnel-step-emoji">üí≥</span>
        <span class="funnel-step-label">Add Payment Info</span>
        <span class="funnel-step-count" id="count-AddPaymentInfo">0</span>
        <span class="funnel-step-pct" id="pct-AddPaymentInfo"></span>
      </div>
      <div class="funnel-step">
        <span class="funnel-step-emoji">‚úÖ</span>
        <span class="funnel-step-label">Purchase</span>
        <span class="funnel-step-count" id="count-Purchase">0</span>
        <span class="funnel-step-pct" id="pct-Purchase"></span>
      </div>
    </div>
  </div>

  <!-- RECENT ACTIVITY -->
  <div class="sec-header anim a6">
    <span class="sec-title">Recent Activity</span>
  </div>

  <div class="recent-list anim a6" id="recentList">
    <div class="recent-empty">Loading...</div>
  </div>

</div>
</div>

<div id="metaModal" class="meta-modal-overlay" onclick="handleMetaModalOverlay(event)">
  <div class="meta-modal" onclick="event.stopPropagation()">
    <div class="meta-modal-header">
      <span class="meta-modal-title">Choose date range</span>
      <div style="display: flex; gap: 6px;">
        <button class="meta-btn" id="metaSelectBtn" onclick="toggleMetaRangeMode()">Range</button>
        <button class="meta-btn" onclick="applyMetaRange()">Done</button>
        <button class="meta-btn" onclick="closeMetaModal()">√ó</button>
      </div>
    </div>
    <div class="meta-modal-body" id="metaModalBody"></div>
  </div>
</div>

<script>
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(function () {});

  const EMOJI_MAP = { Search: 'üîç', AddToCart: 'üõí', InitiateCheckout: 'üìã', AddPaymentInfo: 'üí≥', Purchase: '‚úÖ', PageView: 'üëÅ' };
  let token = '';
  let metaRange = { type: 'last7' };
  let lastMeta = null;
  let metaModalDates = [];
  let metaSelectRange = false;
  let metaRangeStartIndex = null;
  let metaRangeEndIndex = null;

  function formatTime(ts) {
    const d = new Date(ts);
    const now = Date.now();
    const diff = Math.floor((now - ts) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function renderMeta(payload) {
    const container = document.getElementById('metaMetrics');
    if (!container) return;

    if (!payload || payload.enabled === false) {
      container.style.display = 'none';
      return;
    }

    // Show the grid even if data is null (no activity yet for that period)
    container.style.display = 'grid';

    const d = payload.data || {};
    if (payload.data) lastMeta = d;

    const fmtMoney = v => (v != null ? '$' + v.toFixed(2) : '‚Äì');
    const fmtPct = v => (v != null ? v.toFixed(2) + '%' : '‚Äì');

    const set = (id, text) => {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    };

    set('meta-spend', d.spend != null ? fmtMoney(d.spend) : '‚Äì');
    set('meta-cpm', d.cpm != null ? fmtMoney(d.cpm) : '‚Äì');
    set('meta-ctr', d.ctr != null ? fmtPct(d.ctr) : '‚Äì');
    set('meta-roas', d.roas != null ? d.roas.toFixed(2) + 'x' : '‚Äì');

    const ev = d.events || {};
    set('meta-lpv', ev.landing_page_view != null ? ev.landing_page_view : '‚Äì');
    set('meta-search', ev.search != null ? ev.search : '‚Äì');
    set('meta-atc', ev.add_to_cart != null ? ev.add_to_cart : '‚Äì');
    set('meta-ic', ev.initiate_checkout != null ? ev.initiate_checkout : '‚Äì');
    set('meta-api', ev.add_payment_info != null ? ev.add_payment_info : '‚Äì');
    set('meta-purchase', ev.purchase != null ? ev.purchase : '‚Äì');
  }

  function render(data) {
    const { counts, recent } = data || { counts: {}, recent: [] };
    const steps = ['Search', 'AddToCart', 'InitiateCheckout', 'AddPaymentInfo', 'Purchase'];
    const top = counts.Search || 1;

    // Update hero card with conversion metrics
    const searches = counts.Search || 0;
    const carts = counts.AddToCart || 0;
    const purchases = counts.Purchase || 0;
    const conversionRate = searches > 0 ? ((purchases / searches) * 100) : 0;
    
    const heroConvEl = document.getElementById('heroConversionRate');
    const heroBadgeEl = document.getElementById('heroConversionBadge');
    const heroSearchesEl = document.getElementById('heroSearches');
    const heroCartsEl = document.getElementById('heroCarts');
    const heroPurchasesEl = document.getElementById('heroPurchases');
    
    if (heroConvEl) heroConvEl.textContent = conversionRate.toFixed(1) + '%';
    if (heroSearchesEl) heroSearchesEl.textContent = searches;
    if (heroCartsEl) heroCartsEl.textContent = carts;
    if (heroPurchasesEl) heroPurchasesEl.textContent = purchases;
    
    // Update badge based on conversion rate
    if (heroBadgeEl) {
      if (conversionRate >= 5) {
        heroBadgeEl.textContent = '‚Üë Strong';
        heroBadgeEl.className = 'hero-badge';
      } else if (conversionRate >= 2) {
        heroBadgeEl.textContent = '‚Üí Normal';
        heroBadgeEl.className = 'hero-badge';
      } else if (conversionRate > 0) {
        heroBadgeEl.textContent = '‚Üì Low';
        heroBadgeEl.className = 'hero-badge red';
      } else {
        heroBadgeEl.textContent = '‚Äî';
        heroBadgeEl.className = 'hero-badge';
      }
    }

    // Update funnel steps
    steps.forEach(name => {
      const n = counts[name] || 0;
      const el = document.getElementById('count-' + name);
      const pctEl = document.getElementById('pct-' + name);
      if (el) el.textContent = n;
      if (pctEl) pctEl.textContent = top ? Math.round((n / top) * 100) + '%' : '';
    });

    // Update recent activity with new card design
    const list = document.getElementById('recentList');
    if (recent.length === 0) {
      list.innerHTML = '<div class="recent-empty">No events yet. Events appear when users interact with your booking site.</div>';
    } else {
      list.innerHTML = recent.map(e => `
        <div class="recent-item">
          <div class="recent-stripe"></div>
          <div class="recent-icon">${EMOJI_MAP[e.event_name] || '‚Ä¢'}</div>
          <div class="recent-info">
            <div class="recent-event">${e.event_name}</div>
            ${e.content_name ? `<div class="recent-meta">${e.content_name}${e.value ? ' ¬∑ $' + e.value.toFixed(0) : ''}</div>` : ''}
          </div>
          <div class="recent-time">${formatTime(e.timestamp)}</div>
        </div>
      `).join('');
    }

    // Update header date
    document.getElementById('headerDate').textContent = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
  }

  async function doLogin() {
    const pin = document.getElementById('pinInput').value.trim();
    document.getElementById('loginError').textContent = '';
    if (!pin) { document.getElementById('loginError').textContent = 'Enter PIN.'; return; }
    try {
      const res = await fetch('/api/crm/verify', { headers: { 'x-crm-token': pin } });
      const json = await res.json().catch(() => ({}));
      if (res.ok && json.success) {
        token = pin;
        try { localStorage.setItem('crm_token', pin); } catch (e) {}
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        load();
        loadMeta();
      } else {
        document.getElementById('loginError').textContent = 'Wrong PIN.';
      }
    } catch (e) {
      document.getElementById('loginError').textContent = 'Connection failed.';
    }
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }


  async function load() {
    if (!token) return;
    try {
      const res = await fetch('/api/funnel', { headers: { 'x-crm-token': token } });
      if (res.status === 401) {
        token = '';
        try { localStorage.removeItem('crm_token'); } catch (e) {}
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        return;
      }
      const data = await res.json();
      render(data);
    } catch (e) {
      document.getElementById('recentList').innerHTML = '<div class="recent-empty">Failed to load.</div>';
    }
  }

  async function loadMeta() {
    if (!token) return;
    try {
      let qs = '';
      if (metaRange.type === 'today' || metaRange.type === 'yesterday') {
        qs = '?range=' + encodeURIComponent(metaRange.type);
      } else if (metaRange.type === 'custom') {
        qs =
          '?from=' +
          encodeURIComponent(metaRange.from) +
          '&to=' +
          encodeURIComponent(metaRange.to);
      } // last7 -> default on backend

      const res = await fetch('/api/meta-insights' + qs, { headers: { 'x-crm-token': token } });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) {
        renderMeta(null);
        return;
      }
      renderMeta(json);
    } catch (e) {
      renderMeta(null);
    }
  }

  function handleRefresh() {
    load();
    loadMeta();
  }

  function setMetaRange(type) {
    metaRange = { type };
    loadMeta();
  }

  function openMetaModal() {
    const modal = document.getElementById('metaModal');
    const body = document.getElementById('metaModalBody');
    if (!modal || !body) return;
    body.innerHTML = '';

    metaModalDates = [];
    metaSelectRange = false;
    metaRangeStartIndex = null;
    metaRangeEndIndex = null;
    const selectBtn = document.getElementById('metaSelectBtn');
    if (selectBtn) selectBtn.textContent = 'Range';

    const today = new Date();
    for (let i = 0; i < 14; i++) {
      const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
      const label = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      const iso = d.toISOString().split('T')[0];
      metaModalDates.push({ iso });
      const btn = document.createElement('button');
      btn.className = 'meta-date-btn';
      btn.textContent = label;
      btn.dataset.index = String(i);
      btn.onclick = () => onMetaDateClick(i);
      body.appendChild(btn);
    }

    modal.style.display = 'flex';
  }

  function closeMetaModal() {
    const modal = document.getElementById('metaModal');
    if (modal) modal.style.display = 'none';
  }

  function handleMetaModalOverlay(e) {
    if (e.target && e.target.id === 'metaModal') {
      closeMetaModal();
    }
  }

  function onMetaDateClick(index) {
    const entry = metaModalDates[index];
    if (!entry) return;

    if (!metaSelectRange) {
      // Single-day selection
      metaRange = { type: 'custom', from: entry.iso, to: entry.iso };
      closeMetaModal();
      loadMeta();
      return;
    }

    // Range selection mode
    if (metaRangeStartIndex === null) {
      metaRangeStartIndex = index;
      metaRangeEndIndex = index;
    } else {
      metaRangeEndIndex = index;
    }

    if (metaRangeEndIndex < metaRangeStartIndex) {
      const tmp = metaRangeStartIndex;
      metaRangeStartIndex = metaRangeEndIndex;
      metaRangeEndIndex = tmp;
    }
    updateMetaModalSelection();
  }

  function updateMetaModalSelection() {
    const body = document.getElementById('metaModalBody');
    if (!body) return;
    const buttons = body.querySelectorAll('.meta-date-btn');
    buttons.forEach(btn => {
      const idx = parseInt(btn.dataset.index || '-1', 10);
      if (
        metaRangeStartIndex != null &&
        metaRangeEndIndex != null &&
        idx >= metaRangeStartIndex &&
        idx <= metaRangeEndIndex
      ) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
  }

  function toggleMetaRangeMode() {
    metaSelectRange = !metaSelectRange;
    metaRangeStartIndex = null;
    metaRangeEndIndex = null;
    updateMetaModalSelection();
    const btn = document.getElementById('metaSelectBtn');
    if (btn) btn.textContent = metaSelectRange ? 'Single' : 'Range';
  }

  function applyMetaRange() {
    if (metaRangeStartIndex == null || metaRangeEndIndex == null) {
      closeMetaModal();
      return;
    }
    // Indices are newest-first (0 = today), so higher index = earlier date
    const earlierIndex = Math.max(metaRangeStartIndex, metaRangeEndIndex);
    const laterIndex   = Math.min(metaRangeStartIndex, metaRangeEndIndex);
    const start = metaModalDates[earlierIndex];
    const end   = metaModalDates[laterIndex];
    if (!start || !end) {
      closeMetaModal();
      return;
    }
    metaRange = { type: 'custom', from: start.iso, to: end.iso };
    closeMetaModal();
    loadMeta();
  }

  async function copyMetaSummary() {
    if (!lastMeta) return;
    const d = lastMeta;
    const ev = d.events || {};

    const fmtMoney = v => (v != null ? '$' + v.toFixed(2) : '‚Äì');
    const fmtPct = v => (v != null ? v.toFixed(2) + '%' : '‚Äì');

    const localTime = new Date().toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
    const lines = [
      `Copied at: ${localTime} (local time)`,
      '',
      `Date range: ${d.since || ''} ‚Üí ${d.until || ''}`,
      '',
      `Spend: ${fmtMoney(d.spend)}`,
      `CPM: ${fmtMoney(d.cpm)}`,
      `CTR: ${fmtPct(d.ctr)}`,
      `ROAS: ${d.roas != null ? d.roas.toFixed(2) + 'x' : '‚Äì'}`,
      `Cost per LP view: ${fmtMoney(d.cost_per_landing_page_view)}`,
      '',
      `LP views (Meta): ${ev.landing_page_view ?? '‚Äì'}`,
      `Searches (Meta): ${ev.search ?? '‚Äì'}`,
      `Add to Cart (Meta): ${ev.add_to_cart ?? '‚Äì'}`,
      `Initiate Checkout (Meta): ${ev.initiate_checkout ?? '‚Äì'}`,
      `Add Payment Info (Meta): ${ev.add_payment_info ?? '‚Äì'}`,
      `Purchases (Meta): ${ev.purchase ?? '‚Äì'}`,
    ];

    const text = lines.join('\n');

    try {
      await navigator.clipboard.writeText(text);
    } catch (e) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  (function init() {
    const saved = typeof localStorage !== 'undefined' ? localStorage.getItem('crm_token') : null;
    if (saved) {
      token = saved;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      load();
      loadMeta();
    } else if (document.getElementById('pinInput')) {
      document.getElementById('pinInput').focus();
    }
  })();
  setInterval(load, 3000);

  // Push Notification Functions
  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  async function enableFunnelNotifications() {
    if (!token) {
      alert('Please sign in first.');
      return;
    }

    try {
      // Check for browser support
      if (!('Notification' in window)) {
        alert('This browser does not support notifications.');
        return;
      }

      if (!('serviceWorker' in navigator)) {
        alert('This browser does not support service workers.');
        return;
      }

      if (!('PushManager' in window)) {
        alert('Push notifications are not supported on this device. Try Chrome on Android or desktop.');
        return;
      }

      // Request permission
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        alert('Notification permission denied. Enable in browser settings.');
        return;
      }

      // Register service worker
      const registration = await navigator.serviceWorker.register('/sw.js');
      await navigator.serviceWorker.ready;
      console.log('Service Worker registered');

      // Get VAPID public key
      const keyRes = await fetch('/api/push/vapid-public');
      const keyData = await keyRes.json();
      if (!keyData.publicKey) {
        alert('Push notifications not configured on server.');
        return;
      }

      // Check if push manager is available
      if (!registration.pushManager) {
        alert('Push notifications not available in this browser.');
        return;
      }

      // Subscribe to push
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(keyData.publicKey)
      });

      // Convert keys to base64
      const p256dh = btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh'))));
      const auth = btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))));

      // Save subscription to server
      const res = await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-crm-token': token
        },
        body: JSON.stringify({
          endpoint: subscription.endpoint,
          p256dh: p256dh,
          auth: auth,
          source: 'funnel'
        })
      });

      const data = await res.json();
      if (data.ok || data.success) {
        const btn = document.getElementById('btnNotify');
        if (btn) {
          btn.classList.add('active');
        }
        alert('‚úÖ Notifications enabled! You\'ll receive alerts when bookings come in.');
      } else {
        alert('Failed to enable notifications: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Notification error:', error);
      alert('Error enabling notifications: ' + error.message + ' | ' + JSON.stringify(error));
    }
  }

  // Check if already subscribed on load
  async function checkNotificationStatus() {
    if (!token || !('serviceWorker' in navigator)) return;
    
    try {
      const registration = await navigator.serviceWorker.getRegistration();
      if (registration && registration.pushManager) {
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
          const btn = document.getElementById('btnNotify');
          if (btn) {
            btn.classList.add('active');
          }
        }
      }
    } catch (error) {
      console.error('Error checking notification status:', error);
    }
  }

  // Check status after login
  setTimeout(checkNotificationStatus, 1000);
</script>
</body>
</html>
